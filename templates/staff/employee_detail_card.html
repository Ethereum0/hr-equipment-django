<!-- templates/staff/employee_detail_card.html -->

<div class="p-6">
  <!-- –°–æ—Ç—Ä—É–¥–Ω–∏–∫ -->
  <fieldset class="border p-2 mb-1">
    <legend class="text-xl font-bold mb-4 hidden md:block">{{ employee.fio }}</legend>
    <div class="flex flex-col md:flex-row">
      <!-- –§–æ—Ç–æ —Å–ª–µ–≤–∞ -->
      <div class="md:mr-4 mb-4 md:mb-0 flex-shrink-0 flex flex-col items-center">
        {% if employee.ad_login %}
          {% if employee.email %}
            {% with photo_url="https://p-el.ru/mail-photos/"|add:employee.email|add:".jpg" %}
              <img src="{{ photo_url }}" alt="–§–æ—Ç–æ {{ employee.fio }}" class="w-32 h-32 object-cover rounded mb-3" onerror="this.onerror=null; this.src='/static/images/no-photo-icon.png';">
            {% endwith %}
          {% else %}
            {% with photo_url="https://p-el.ru/mail-photos/"|add:employee.ad_login|add:"@p-el.ru.jpg" %}
              <img src="{{ photo_url }}" alt="–§–æ—Ç–æ {{ employee.fio }}" class="w-32 h-32 object-cover rounded mb-3" onerror="this.onerror=null; this.src='/static/images/no-photo-icon.png';">
            {% endwith %}
          {% endif %}
        {% else %}
          <div class="w-32 h-32 bg-gray-200 rounded mb-2 flex items-center justify-center">
            <span class="text-xs text-gray-500">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
          </div>
        {% endif %}
            <div>
            {% comment %} <p class="text-sm text-gray-600">–°—Ç–∞—Ç—É—Å</p> {% endcomment %}
            <form id="status-form" class="inline">
                {% csrf_token %}
                <select name="status" id="status-select" class="px-2 py-1 text-xs rounded text-center {{ employee.get_status_badge_class }}" 
                        onchange="changeEmployeeStatus({{ employee.pk }}, this.value)">
                {% for value, label in employee.STATUS_CHOICES %}
                    <option value="{{ value }}" {% if employee.status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
                </select>
            </form>
            </div>
          <div>
            <p class="text-xs text-gray-500">–ù–æ–º–µ—Ä SIP</p>
            {% if employee.sip_number %}
              <p class="text-sm text-center break-words">
                <a href="tel:{{ employee.sip_number }}" 
                   class="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer"
                   onclick="open3CX('{{ employee.sip_number }}', event)">
                  {{ employee.sip_number }} üìû
                </a>
              </p>
            {% else %}
              <p class="text-sm text-center break-words">‚Äî</p>
            {% endif %}
          </div>
        <!-- –§–ò–û –ø–æ–¥ —Ñ–æ—Ç–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, —Ä—è–¥–æ–º –Ω–∞ –±–æ–ª—å—à–∏—Ö -->
        <h2 class="text-xl font-bold text-center md:hidden">{{ employee.fio }}</h2>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–ø—Ä–∞–≤–∞ -->
      <div class="flex-grow">
        <!-- –§–ò–û –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö —Ä—è–¥–æ–º —Å —Ñ–æ—Ç–æ -->
        {% comment %} <h2 class="text-xl font-bold mb-4 hidden md:block">{{ employee.fio }}</h2> {% endcomment %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="text-sm text-gray-600">–î–æ–ª–∂–Ω–æ—Å—Ç—å</p>
            <p>{{ employee.position|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</p>
            <p>{{ employee.hire_date|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">–¢–µ–ª–µ—Ñ–æ–Ω</p>
            {% if employee.phone %}
              <p>
                <a href="tel:{{ employee.phone }}" 
                   class="text-blue-600 hover:text-blue-800 hover:underline"
                   onclick="open3CX('{{ employee.phone }}', event)">
                  {{ employee.phone }} üìû
                </a>
              </p>
            {% else %}
              <p>‚Äî</p>
            {% endif %}
          </div>
          <div>
            <p class="text-sm text-gray-600">–û—Ñ–∏—Å</p>
            <p>{{ employee.get_office_display }}</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</p>
            <p>{{ employee.supervisor.fio|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">–û—Ç–¥–µ–ª</p>
            <p>{{ employee.department|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">–î–∞—Ç–∞ —É–≤–æ–ª—å–Ω–µ–Ω–∏—è</p>
            <p>{{ employee.dismissal_date|default:"‚Äî" }}</p>
          </div>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ 6 –∫–æ–ª–æ–Ω–æ–∫, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ -->
  <fieldset class="border p-4 mb-6">
    <legend class="text-lg font-semibold px-2">–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</legend>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6">
      <!-- –ì—Ä—É–ø–ø–∞ 1: AD -->
      <div class="border rounded-lg p-3 bg-blue-50 border-blue-200">
        <h3 class="text-md font-medium text-blue-800 mb-2 pb-1 border-b border-blue-100">AD</h3>
        <div class="space-y-2">
          <div>
            <p class="text-xs text-gray-500">–õ–æ–≥–∏–Ω</p>
            <p class="text-sm break-words">CORP\{{ employee.ad_login|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</p>
            <p class="text-sm break-words">{{ employee.ad_password|default:"‚Äî" }}</p>
          </div>
        </div>
      </div>

      <!-- –ì—Ä—É–ø–ø–∞ 2: Email -->
      <div class="border rounded-lg p-3 bg-green-50 border-green-200">
        <h3 class="text-md font-medium text-green-800 mb-2 pb-1 border-b border-green-100">Email</h3>
        <div class="space-y-2">
          <div>
            <p class="text-xs text-gray-500">–õ–æ–≥–∏–Ω</p>
            <p class="text-sm break-words">{{ employee.email|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</p>
            <p class="text-sm break-words">{{ employee.email_password|default:"‚Äî" }}</p>
          </div>
        </div>
      </div>

      <!-- –ì—Ä—É–ø–ø–∞ 3: SIP / 3CX -->
      <div class="border rounded-lg p-3 bg-purple-50 border-purple-200">
        <h3 class="text-md font-medium text-purple-800 mb-2 pb-1 border-b border-purple-100">SIP / 3CX</h3>
        <div class="space-y-2">
          <div>
            <p class="text-xs text-gray-500">–ù–æ–º–µ—Ä SIP</p>
            {% if employee.sip_number %}
              <p class="text-sm break-words">
                <a href="tel:{{ employee.sip_number }}" 
                   class="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer"
                   onclick="open3CX('{{ employee.sip_number }}', event)">
                  {{ employee.sip_number }} üìû
                </a>
              </p>
            {% else %}
              <p class="text-sm break-words">‚Äî</p>
            {% endif %}
          </div>
          <div>
            <p class="text-xs text-gray-500">3CX WEB –ø–∞—Ä–æ–ª—å</p>
            <p class="text-sm break-words">{{ employee.web_3cx|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å 3CX</p>
            <p class="text-sm break-words">{{ employee.pass_3cx|default:"‚Äî" }}</p>
          </div>
        </div>
      </div>

      <!-- –ì—Ä—É–ø–ø–∞ 4: –ë–∏—Ç—Ä–∏–∫—Å24 -->
      <div class="border rounded-lg p-3 bg-amber-50 border-amber-200">
        <h3 class="text-md font-medium text-amber-800 mb-2 pb-1 border-b border-amber-100">–ë–∏—Ç—Ä–∏–∫—Å24</h3>
        <div class="space-y-2">
          <div>
            <p class="text-xs text-gray-500">–õ–æ–≥–∏–Ω</p>
            <p class="text-sm break-words">{{ employee.b24_login|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</p>
            <p class="text-sm break-words">{{ employee.b24_password|default:"‚Äî" }}</p>
          </div>
        </div>
      </div>

      <!-- –ì—Ä—É–ø–ø–∞ 5: –¢–µ–ª–µ—Ñ–æ–Ω–∏—è –ë24 -->
      <div class="border rounded-lg p-3 bg-cyan-50 border-cyan-200">
        <h3 class="text-md font-medium text-cyan-800 mb-2 pb-1 border-b border-cyan-100">–¢–µ–ª–µ—Ñ–æ–Ω–∏—è –ë24</h3>
        <div class="space-y-2">
          <div>
            <p class="text-xs text-gray-500">–õ–æ–≥–∏–Ω</p>
            <p class="text-sm break-words">{{ employee.tel_b24_login|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</p>
            <p class="text-sm break-words">{{ employee.tel_b24_password|default:"‚Äî" }}</p>
          </div>
        </div>
      </div>

      <!-- –ì—Ä—É–ø–ø–∞ 6: –í–ê–¢–° -->
      <div class="border rounded-lg p-3 bg-red-50 border-red-200">
        <h3 class="text-md font-medium text-red-800 mb-2 pb-1 border-b border-red-100">–í–ê–¢–°</h3>
        <div class="space-y-2">
          <div>
            <p class="text-xs text-gray-500">–õ–æ–≥–∏–Ω</p>
            <p class="text-sm break-words">{{ employee.vats_login|default:"‚Äî" }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</p>
            <p class="text-sm break-words">{{ employee.vats_password|default:"‚Äî" }}</p>
          </div>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- –í –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
  <div class="border p-4 mb-6">
      <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold">–°—Ç–∞—Ç—É—Å AD 
              <span class="text-xs text-green-400">(real-time)</span>
          </h3>
          <button onclick="checkADStatus({{ employee.pk }})" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">
              üîÑ –û–±–Ω–æ–≤–∏—Ç—å
          </button>
      </div>
      <div id="ad-status-{{ employee.pk }}" class="text-sm">
          <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</p>
      </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
  <div class="mt-6 flex flex-wrap gap-2">
    <a href="{% url 'employee_edit' employee.pk %}" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
    <button
      onclick="copyToClipboardHTML({
        fio: '{{ employee.fio|escapejs }}',
        ad_login: '{{ employee.ad_login|escapejs }}',
        ad_password: '{{ employee.ad_password|escapejs }}',
        email: '{{ employee.email|escapejs }}',
        email_password: '{{ employee.email_password|escapejs }}',
        b24_login: '{{ employee.b24_login|escapejs }}',
        b24_password: '{{ employee.b24_password|escapejs }}',
        sip_number: '{{ employee.sip_number|escapejs }}',
        web_3cx: '{{ employee.web_3cx|escapejs }}',
        pass_3cx: '{{ employee.pass_3cx|escapejs }}',
        tel_b24_login: '{{ employee.tel_b24_login|escapejs }}',
        tel_b24_password: '{{ employee.tel_b24_password|escapejs }}',
        vats_login: '{{ employee.vats_login|escapejs }}',
        vats_password: '{{ employee.vats_password|escapejs }}'
      })"
      class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
    >
      –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è Bitrix
    </button>
    <!-- –ö–Ω–æ–ø–∫–∞ AnyDesk -->
    {% if employee.laptop_anydesk_id %}
      <button onclick="openAnyDesk('{{ employee.laptop_anydesk_id|escapejs }}')" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">AnyDesk</button>
    {% else %}
      <button disabled class="px-4 py-2 bg-gray-400 text-white rounded cursor-not-allowed">AnyDesk (–Ω–µ—Ç ID)</button>
    {% endif %}

    <!-- –ö–Ω–æ–ø–∫–∞ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ -->
    {% if employee.pk %}
        <button onclick="openEquipmentModal('{{ employee.pk }}', '{{ employee.fio|escapejs }}')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</button>
    {% else %} 
        <button disabled class="px-4 py-2 bg-gray-400 text-white rounded cursor-not-allowed">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–Ω–µ—Ç)</button> 
    {% endif %} 
    
      <!-- üîß –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ Provisioning -->
    {% if employee.pk %}
      <button onclick="goToProvisioning('{{ employee.pk }}', '{{ employee.fio|escapejs }}')" 
              class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
              Provisioning
      </button>
    {% else %}
      <button disabled 
              class="px-4 py-2 bg-gray-400 text-white rounded cursor-not-allowed">
              Provisioning (–Ω–µ—Ç)
      </button>
    {% endif %}
  </div>


    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  {% if employee.info %}
  <fieldset class="border p-4 mb-6">
    <legend class="text-lg font-semibold px-2">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</legend>
    <div class="bg-gray-50 p-3 rounded">
      <p class="text-sm whitespace-pre-wrap">{{ employee.info }}</p>
    </div>
  </fieldset>
  {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
<div id="equipment-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-75" onclick="closeEquipmentModal(event)">
  <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
    <div class="flex items-center justify-between p-4 border-b">
      <h3 class="text-lg font-semibold">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: <span id="modal-employee-name"></span></h3>
      <button onclick="closeEquipmentModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
    </div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
    <div id="modal-content" class="flex-grow overflow-y-auto p-4">
      <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å—é–¥–∞ —á–µ—Ä–µ–∑ AJAX -->
      <p class="text-gray-500 text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
    <div class="flex items-center justify-between p-4 border-t">
      <div>
        <button 
            id="copy-equipment-btn" 
            onclick="copyEquipmentFromTable()" 
            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 mr-2"
        >
            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤ –ë–∏—Ç—Ä–∏–∫—Å
        </button>
        <a id="go-to-equipment-btn" href="{% url 'equipment_list' %}?employee={{ selected_employee.id }}" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">–ü–µ—Ä–µ–π—Ç–∏ –≤ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>      </div>
      <button onclick="closeEquipmentModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
/**
 * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç 3CX —Å –Ω–∞–±—Ä–∞–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º
 * @param {string} phoneNumber - –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –Ω–∞–±–æ—Ä–∞
 * @param {Event} event - –°–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞
 */
function open3CX(phoneNumber, event) {
  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å—Å—ã–ª–∫–∏
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  
  // –û—á–∏—â–∞–µ–º –Ω–æ–º–µ—Ä –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
  const cleanNumber = phoneNumber.replace(/\D/g, '');
  
  if (!cleanNumber) {
    alert('–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ —É–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
    return;
  }
  
  // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å—Ö–µ–º—ã URI –¥–ª—è 3CX
  const schemes = [
    `tel:${cleanNumber}`,                    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è tel: —Å—Ö–µ–º–∞
    `callto:${cleanNumber}`,                 // –°—Ö–µ–º–∞ callto:
    `sip:${cleanNumber}`,                    // SIP —Å—Ö–µ–º–∞
    `3cx:call?number=${cleanNumber}`,        // –ü—Ä—è–º–∞—è —Å—Ö–µ–º–∞ 3CX
    `threecx:call?number=${cleanNumber}`,    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Å—Ö–µ–º–∞ 3CX
  ];
  
  let success = false;
  
  // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –ø–æ –∫–∞–∂–¥–æ–π —Å—Ö–µ–º–µ
  schemes.forEach(scheme => {
    if (!success) {
      try {
        const link = document.createElement('a');
        link.href = scheme;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        success = true;
        console.log(`–£—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ —Å—Ö–µ–º—É: ${scheme}`);
      } catch (e) {
        console.log(`–°—Ö–µ–º–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞: ${scheme}`, e);
      }
    }
  });
  
  // –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ —Å—Ö–µ–º–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
  if (!success) {
    const userAction = confirm(
      `–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å 3CX.\n\n` +
      `–ù–æ–º–µ—Ä: ${cleanNumber}\n\n` +
      `–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞?`
    );
    
    if (userAction) {
      navigator.clipboard.writeText(cleanNumber).then(() => {
        alert(`–ù–æ–º–µ—Ä ${cleanNumber} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –≤ 3CX –≤—Ä—É—á–Ω—É—é.`);
      }).catch(() => {
        alert(`–ù–æ–º–µ—Ä –¥–ª—è –Ω–∞–±–æ—Ä–∞: ${cleanNumber}\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ 3CX.`);
      });
    }
  }
}

/**
 * –ö–æ–ø–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.
 * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.
 */
async function copyToClipboardHTML(employee) {
  const htmlTable = `
<table border="1" cellpadding="2" cellspacing="0">
<tr><td>–§–ò–û :</td><td>${employee.fio || "‚Äî"}</td></tr>
<tr><td>AD :</td><td>${employee.ad_login ? 'CORP\\' + employee.ad_login : '‚Äî'}</td></tr>
<tr><td>–ü–∞—Ä–æ–ª—å:</td><td>${employee.ad_password || '‚Äî'}</td></tr>
<tr><td>Email :</td><td>${employee.email ? `<a href="https://mail.p-el.ru/owa" target="_blank">${employee.email}</a>` : '‚Äî'}</td></tr>
<tr><td>Email –ø–∞—Ä–æ–ª—å:</td><td>${employee.email_password || '‚Äî'}</td></tr>
<tr><td>–ë–∏—Ç—Ä–∏–∫—Å24 :</td><td>${employee.b24_login ? `<a href="https://b24.p-el.ru/" target="_blank">${employee.b24_login}</a>` : '‚Äî'}</td></tr>
<tr><td>–ü–∞—Ä–æ–ª—å –ë24:</td><td>${employee.b24_password || '‚Äî'}</td></tr>
<tr><td>SIP :</td><td>${employee.sip_number || '‚Äî'}</td></tr>
<tr><td>3CX :</td><td>${employee.web_3cx || '‚Äî'}</td></tr>
<tr><td>–ü–∞—Ä–æ–ª—å 3CX:</td><td>${employee.pass_3cx || '‚Äî'}</td></tr>
<tr><td>–¢–µ–ª–µ—Ñ–æ–Ω–∏—è –ë24 :</td><td>${employee.tel_b24_login || '‚Äî'}</td></tr>
<tr><td>–ü–∞—Ä–æ–ª—å –¢–µ–ª–µ—Ñ–æ–Ω–∏—è:</td><td>${employee.tel_b24_password || '‚Äî'}</td></tr>
<tr><td>–í–ê–¢–° :</td><td>${employee.vats_login || '‚Äî'}</td></tr>
<tr><td>–ü–∞—Ä–æ–ª—å –í–ê–¢–°:</td><td>${employee.vats_password || '‚Äî'}</td></tr>
</table>
`;

  try {
    await navigator.clipboard.write([
      new ClipboardItem({
        'text/html': new Blob([htmlTable], { type: 'text/html' }),
        'text/plain': new Blob([htmlTable], { type: 'text/plain' })
      })
    ]);
    alert('–î–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã ‚úÖ');
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è HTML:', e);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä.');
  }
}

/**
 * –ö–æ–ø–∏—Ä—É–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ –≤–∏–¥–∏–º–æ–π —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
 */
async function copyEquipmentFromTable() {
  try {
    const modalContent = document.getElementById('modal-content');
    if (!modalContent) {
      alert('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
      return;
    }

    const table = modalContent.querySelector('table');
    if (!table) {
      alert('–¢–∞–±–ª–∏—Ü–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      return;
    }

    const rows = table.querySelectorAll('tr');
    if (rows.length <= 1) {
      alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
      return;
    }

    // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    const employeeName = document.getElementById('modal-employee-name').textContent;

    // –°–æ–∑–¥–∞–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Ç–æ–ª—å–∫–æ —Å –Ω—É–∂–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
    let htmlTable = `
<table border="1" cellpadding="4" cellspacing="0" style="border-collapse: collapse; font-family: Arial, sans-serif;">
<caption style="font-weight: bold; font-size: 14px; margin-bottom: 8px;">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: ${employeeName}</caption>
<tr style="background-color: #f8f9fa;">
    <th style="border: 1px solid #dee2e6; padding: 8px; text-align: left;">–¢–∏–ø –¢–ú–¶</th>
    <th style="border: 1px solid #dee2e6; padding: 8px; text-align: left;">–ú–æ–¥–µ–ª—å</th>
    <th style="border: 1px solid #dee2e6; padding: 8px; text-align: left;">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
</tr>`;

    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞) –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    let equipmentCount = 0;
    for (let i = 1; i < rows.length; i++) {
      const cells = rows[i].querySelectorAll('td');
      
      // –ú–∏–Ω–∏–º—É–º 3 —è—á–µ–π–∫–∏: –¢–∏–ø, –ú–æ–¥–µ–ª—å, –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä
      if (cells.length >= 3) {
        const type = cells[0].textContent.trim();
        const model = cells[1].textContent.trim();
        const serial = cells[2].textContent.trim();
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        if (type || model || serial) {
          htmlTable += `
<tr>
    <td style="border: 1px solid #dee2e6; padding: 6px;">${type || "‚Äî"}</td>
    <td style="border: 1px solid #dee2e6; padding: 6px;">${model || "‚Äî"}</td>
    <td style="border: 1px solid #dee2e6; padding: 6px;">${serial || "‚Äî"}</td>
</tr>`;
          equipmentCount++;
        }
      }
    }

    htmlTable += '</table>';

    if (equipmentCount === 0) {
      alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
      return;
    }

    // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    let textTable = `–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: ${employeeName}\n\n`;
    textTable += '–¢–∏–ø –¢–ú–¶\t–ú–æ–¥–µ–ª—å\t–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä\n';
    
    for (let i = 1; i < rows.length; i++) {
      const cells = rows[i].querySelectorAll('td');
      if (cells.length >= 3) {
        const type = cells[0].textContent.trim();
        const model = cells[1].textContent.trim();
        const serial = cells[2].textContent.trim();
        
        if (type || model || serial) {
          textTable += `${type || "‚Äî"}\t${model || "‚Äî"}\t${serial || "‚Äî"}\n`;
        }
      }
    }

    // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    await navigator.clipboard.write([
      new ClipboardItem({
        'text/html': new Blob([htmlTable], { type: 'text/html' }),
        'text/plain': new Blob([textTable], { type: 'text/plain' })
      })
    ]);
    
    alert(`–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! ‚úÖ\n\n–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü: ${equipmentCount}\n–ü–æ–ª—è: –¢–∏–ø –¢–ú–¶, –ú–æ–¥–µ–ª—å, –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä`);
    
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', e);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ. –û—à–∏–±–∫–∞: ' + e.message);
  }
}

/**
 * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç AnyDesk —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID.
 * @param {string} anydeskId - ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ AnyDesk.
 */
function openAnyDesk(anydeskId) {
  if (!anydeskId) {
    alert('ID AnyDesk –Ω–µ —É–∫–∞–∑–∞–Ω.');
    return;
  }

  // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –∑–∞–ø—É—Å–∫–∞ AnyDesk
  const anyDeskUrl = `anydesk:${anydeskId}`;

  // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
  window.open(anyDeskUrl, '_self');

  // Fallback: –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª anydesk:, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
  {% comment %} settimeout(() => {
    alert(`–µ—Å–ª–∏ anydesk –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:\n\n1. –æ—Ç–∫—Ä–æ–π—Ç–µ anydesk –≤—Ä—É—á–Ω—É—é.\n2. –≤–≤–µ–¥–∏—Ç–µ id: ${anydeskid}\n3. –Ω–∞–∂–º–∏—Ç–µ "–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è".`);
  }, 1000); {% endcomment %}
}

/**
 * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
 * @param {string} employeeId - ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
 * @param {string} employeeName - –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
 */
function openEquipmentModal(employeeId, employeeName) {
  const modal = document.getElementById('equipment-modal');
  const modalContent = document.getElementById('modal-content');
  const modalEmployeeName = document.getElementById('modal-employee-name');
  const copyBtn = document.getElementById('copy-equipment-btn');
  const goToBtn = document.getElementById('go-to-equipment-btn');

  if (modal && modalContent && modalEmployeeName && copyBtn && goToBtn) {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
    modalEmployeeName.textContent = employeeName;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É "–ü–µ—Ä–µ–π—Ç–∏ –≤ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
    goToBtn.href = `/equipment/?employee=${employeeId}`;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —á–µ—Ä–µ–∑ AJAX
    fetch(`/employee/${employeeId}/equipment/`)
      .then(response => response.text())
      .then(html => {
        modalContent.innerHTML = html;
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
        modalContent.innerHTML = '<p class="text-red-500 text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.</p>';
      });
  } else {
    console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
  }
}

/**
 * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.
 * @param {Event} [event] - –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞).
 */
function closeEquipmentModal(event) {
  const modal = document.getElementById('equipment-modal');
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –ù–ï –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  if (!event || event.target.id === 'equipment-modal') {
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }
}

/**
 * –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.
 */
function copyEquipmentData() {
  // –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (—Ç–∞–±–ª–∏—Ü—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è)
  const modalContent = document.getElementById('modal-content');
  if (modalContent) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
    const table = modalContent.querySelector('table');
    if (table) {
      let markdown = '';
      const rows = table.querySelectorAll('tr');
      rows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td, th');
        const cellTexts = Array.from(cells).map(cell => cell.textContent.trim());
        markdown += '| ' + cellTexts.join(' | ') + ' |\n';
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        if (rowIndex === 0) {
          markdown += '| ' + cellTexts.map(() => '---').join(' | ') + ' |\n';
        }
      });
      navigator.clipboard.writeText(markdown).then(() => {
        alert('–î–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!');
      }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.');
      });
    } else {
      alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.');
    }
  }
}

function changeEmployeeStatus(employeeId, newStatus) {
    const selectElement = document.getElementById('status-select');
    const originalClass = selectElement.className;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
    selectElement.disabled = true;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX-–∑–∞–ø—Ä–æ—Å
    fetch(`/employee/${employeeId}/change-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: `status=${encodeURIComponent(newStatus)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Å–µ–ª–µ–∫—Ç–∞
            selectElement.className = `px-2 py-1 text-xs rounded ${data.status_badge_class}`;
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            alert(data.message);
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å
            selectElement.className = originalClass;
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å
        selectElement.className = originalClass;
    })
    .finally(() => {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç
        selectElement.disabled = false;
    });
}

function goToProvisioning(employeeId, fio) {
  // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É Provisioning —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
  const url = `/provisioning/?employee_id=${employeeId}`;
  window.location.href = url;
}
let eventSource = null;
const employeeId = {{ employee.pk }};

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å AD –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
function checkADStatus(employeeId) {
    const statusDiv = document.getElementById(`ad-status-${employeeId}`);
    statusDiv.innerHTML = '<p class="text-blue-500">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å AD...</p>';
    
    fetch(`/employee/${employeeId}/ad-status/`)
        .then(r => r.json())
        .then(data => {
            updateADStatusDisplay(employeeId, data);
        })
        .catch(error => {
            statusDiv.innerHTML = `<p class="text-red-500">‚ùå –û—à–∏–±–∫–∞: ${error}</p>`;
        });
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ AD
 */
function updateADStatusDisplay(employeeId, data) {
    const statusDiv = document.getElementById(`ad-status-${employeeId}`);
    
    if (data.error) {
        statusDiv.innerHTML = `<p class="text-red-500">‚ùå ${data.error}</p>`;
    } else if (!data.found) {
        statusDiv.innerHTML = '<p class="text-yellow-500">‚ö† –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ AD</p>';
    } else {
        let html = `<p>üîì <span class="${data.locked ? 'text-red-500' : 'text-green-500'}">`;
        html += `${data.locked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω'}</span>`;
        html += ` <span class="text-gray-400 text-xs">(${new Date().toLocaleTimeString()})</span></p>`;
        
        if (data.locked) {
            html += `<button onclick="unlockAD(${employeeId})" class="mt-2 px-3 py-1 bg-green-500 text-white rounded text-sm">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
        }
        
        statusDiv.innerHTML = html;
    }
}

/**
 * –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ AD
 */
function unlockAD(employeeId) {
    const statusDiv = document.getElementById(`ad-status-${employeeId}`);
    statusDiv.innerHTML = '<p class="text-blue-500">–†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º...</p>';
    
    fetch(`/employee/${employeeId}/unlock-ad/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `<p class="text-green-500">‚úÖ ${data.message}</p>`;
            // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            setTimeout(() => checkADStatus(employeeId), 2000);
        } else {
            statusDiv.innerHTML = `<p class="text-red-500">‚ùå ${data.error}</p>`;
        }
    });
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    if (employeeId) {
        // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å
        checkADStatus(employeeId);
    }
});
</script>