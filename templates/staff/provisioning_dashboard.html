<!-- templates/staff/provisioning_dashboard.html -->
{% extends 'staff/base.html' %}

{% block content %}
<div class="p-6 space-y-6">
  <h1 class="text-2xl font-bold mb-6">üîß Provisioning</h1>

  <!-- === –ì–†–£–ü–ü–ê 1: –í—ã–±–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ === -->
  <form method="get" class="p-2 border rounded bg-white shadow-sm">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
      <div>
        <label for="employee-select" class="block text-sm font-medium text-gray-700 mb-1">
          –í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        </label>
        <select id="employee-select" name="employee_id" class="w-full px-3 py-2 border rounded">
          <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>
          {% for emp in active_employees %}
            <option value="{{ emp.id }}" {% if selected_employee and selected_employee.id == emp.id %}selected{% endif %}>{{ emp.fio }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          –ü–æ–∫–∞–∑–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
        </button>
        <a href="{% url 'provisioning_dashboard' %}" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
          –°–±—Ä–æ—Å–∏—Ç—å
        </a>
      </div>
    </div>
  </form>

{% if selected_employee %}
  <!-- === –ì–†–£–ü–ü–ê 2: –¢–∞–±–ª–∏—Ü–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è === -->
  <div class="p-2 border rounded bg-white shadow-sm">
    <h2 class="text-xl font-semibold mb-4">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: {{ selected_employee.fio }}</h2>

    {% if sip_phones %}
<div class="overflow-x-auto mb-6">
  <table class="min-w-full bg-white border" id="sip-table">
    <thead class="bg-gray-100">
      <tr>
        <th class="py-2 px-4 text-left">–í—ã–±–æ—Ä</th>
        <th class="py-2 px-4 text-left">–¢–∏–ø –¢–ú–¶</th>
        <th class="py-2 px-4 text-left">–ú–æ–¥–µ–ª—å</th>
        <th class="py-2 px-4 text-left">–°–µ—Ä–∏–π–Ω—ã–π ‚Ññ</th>
        <th class="py-2 px-4 text-left">MAC –∞–¥—Ä–µ—Å</th>
        <th class="py-2 px-4 text-left">(SIP) IP/AnyDesk</th>
        <th class="py-2 px-4 text-left">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for eq in sip_phones %}
        <tr class="border-t sip-phone-row {% if forloop.first %}selected-phone bg-blue-50{% endif %}" 
            data-eqid="{{ eq.id }}" 
            data-mac="{{ eq.mac_address|default:'' }}"
            data-ip="{{ eq.ip_or_anydesk|default:'' }}"
            data-model="{{ eq.model|default:'' }}">
          <!-- –í—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
          <td class="py-2 px-4">
            <input type="radio" name="selected_phone" value="{{ eq.id }}" 
                   {% if forloop.first %}checked{% endif %}
                   class="phone-selector">
          </td>
          
          <!-- –¢–∏–ø –¢–ú–¶ -->
          <td class="py-2 px-4 type-cell">{{ eq.get_type_display }}</td>

          <!-- –ú–æ–¥–µ–ª—å -->
          <td class="py-2 px-4 model-cell">
            <span class="view">{{ eq.model|default:"‚Äî" }}</span>
            <input class="edit hidden w-full px-2 py-1 border rounded text-sm" name="model" value="{{ eq.model|default_if_none:'' }}">
          </td>

          <!-- –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä -->
          <td class="py-2 px-4 serial-cell">
            <span class="view">{{ eq.serial_number|default:"‚Äî" }}</span>
            <input class="edit hidden w-full px-2 py-1 border rounded text-sm" name="serial_number" value="{{ eq.serial_number|default_if_none:'' }}">
          </td>

          <!-- MAC –∞–¥—Ä–µ—Å -->
          <td class="py-2 px-4 mac-cell">
            <span class="view">{{ eq.mac_address|default:"‚Äî" }}</span>
            <input class="edit hidden w-full px-2 py-1 border rounded text-sm" name="mac_address" value="{{ eq.mac_address|default_if_none:'' }}">
          </td>

          <!-- IP / AnyDesk -->
          <td class="py-2 px-4 ip-cell">
            <span class="view">{{ eq.ip_or_anydesk|default:"‚Äî" }}</span>
            <input class="edit hidden w-full px-2 py-1 border rounded text-sm" name="ip_or_anydesk" value="{{ eq.ip_or_anydesk|default_if_none:'' }}">
          </td>

          <!-- –î–µ–π—Å—Ç–≤–∏—è -->
          <td class="py-2 px-4">
            <div class="flex gap-2">
              <button class="btn-edit px-2 py-1 bg-yellow-400 rounded text-sm">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn-save hidden px-2 py-1 bg-green-600 text-white rounded text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn-cancel hidden px-2 py-1 bg-gray-300 rounded text-sm">–û—Ç–º–µ–Ω–∞</button>
              <div class="mt-1 text-xs text-green-600 success-msg hidden">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
              <div class="mt-1 text-xs text-red-600 error-msg hidden"></div>
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

    {% else %}
      <p class="text-gray-600 mb-6">–ù–µ—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö SIP-—Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤.</p>
    {% endif %}
  </div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- === –ì–†–£–ü–ü–ê 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ === -->
  <div class="p-4 border rounded bg-white shadow-sm">
    <h2 class="text-lg font-semibold mb-4">‚öôÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h2>
    
    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ MAC-–∞–¥—Ä–µ—Å–∞ -->
    <div class="mb-4 p-3 bg-gray-50 rounded border">
      <p class="text-sm text-gray-600">–í—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</p>
      <p class="font-mono text-sm" id="config-selected-mac">‚Äî</p>
    </div>

    <div class="flex items-center gap-3 mb-3">
      <button id="generate-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
        üîß –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
      </button>

      <button id="save-btn" class="bg-green-500 text-white px-4 py-2 rounded hidden">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
      </button>
    </div>

    <textarea id="config-output" rows="8" class="w-full border p-2 font-mono text-sm" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏..."></textarea>
  </div>

  <!-- === –ì–†–£–ü–ü–ê 4: –≠–∫—Ä–∞–Ω SIP-—Ç–µ–ª–µ—Ñ–æ–Ω–∞ === -->
  <div class="p-4 border rounded bg-white shadow-sm">
    <h2 class="text-lg font-semibold mb-4">üì∑ –≠–∫—Ä–∞–Ω SIP-—Ç–µ–ª–µ—Ñ–æ–Ω–∞</h2>

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ MAC-–∞–¥—Ä–µ—Å–∞ -->
    <div class="mb-4 p-3 bg-gray-50 rounded border">
      <p class="text-sm text-gray-600">–í—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</p>
      <p class="font-mono text-sm" id="sip-selected-mac">‚Äî</p>
    </div>

    <!-- Login/Password -->
    <div class="flex items-center gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Login</label>
        <input type="text" id="sip-login" value="admin" class="border px-2 py-1 rounded w-32">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input type="text" id="sip-password" value="admin" class="border px-2 py-1 rounded w-32">
      </div>
      <button id="btn-sip-screen" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 mt-5">
        üñº –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
      </button>
      <div class="flex gap-2">
        <button class="sip-cmd bg-purple-500 text-white px-3 py-2 rounded mt-4" data-cmd="DNDOn">‚èπ DNDon</button>
        <button class="sip-cmd bg-purple-500 text-white px-3 py-2 rounded mt-4" data-cmd="DNDOff">‚èπ DNDOff</button>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º -->
    <div class="flex flex-col lg:flex-row items-start gap-6">
      <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –∫–æ–º–∞–Ω–¥ -->
      <div class="flex flex-col gap-2">
        <button class="sip-cmd bg-yellow-500 text-white px-3 py-1 rounded" data-cmd="Reboot">üîÅ Reboot</button>
        <button class="sip-cmd bg-red-500 text-white px-3 py-1 rounded" data-cmd="Reset">‚öôÔ∏è Reset</button>
        <button class="sip-cmd bg-green-600 text-white px-3 py-1 rounded" data-cmd="AutoP">‚ö° AutoP</button>
      </div>

      <!-- –¶–µ–Ω—Ç—Ä: —ç–∫—Ä–∞–Ω -->
      <div id="sip-screen-section" class="border rounded shadow-md w-[350px] h-auto">
        <img id="sip-screen-img" src="\static\images\no_sip.png" alt="SIP —ç–∫—Ä–∞–Ω" class="border rounded shadow-md w-[350px] h-auto">
        <div class="flex gap-4">
          <button class="sip-cmd bg-gray-500 text-white px-4 py-1 rounded mt-1" data-cmd="F1">‚èπ F1</button>
          <button class="sip-cmd bg-gray-500 text-white px-4 py-1 rounded mt-1" data-cmd="F2">‚èπ F2</button>
          <button class="sip-cmd bg-gray-500 text-white px-4 py-1 rounded mt-1" data-cmd="F3">‚èπ F3</button>
          <button class="sip-cmd bg-gray-500 text-white px-4 py-1 rounded mt-1" data-cmd="F4">‚èπ F4</button>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
      <div class="flex flex-col items-center gap-2">
        <button class="sip-cmd bg-gray-400 px-3 py-1 rounded" data-cmd="UP">‚¨ÜÔ∏è</button>
        <div class="flex gap-2">
          <button class="sip-cmd bg-gray-400 px-3 py-1 rounded" data-cmd="LEFT">‚¨ÖÔ∏è</button>
          <button class="sip-cmd bg-blue-500 text-white px-3 py-1 rounded" data-cmd="OK">üÜó</button>
          <button class="sip-cmd bg-gray-400 px-3 py-1 rounded" data-cmd="RIGHT">‚û°Ô∏è</button>
        </div>
        <button class="sip-cmd bg-gray-400 px-3 py-1 rounded" data-cmd="DOWN">‚¨áÔ∏è</button>
        <button class="sip-cmd bg-orange-500 text-white px-3 py-1 rounded" data-cmd="MENU">üìã Menu</button>
        <button class="sip-cmd bg-pink-500 text-white px-3 py-1 rounded" data-cmd="BACK_IDLE">üîô Back Idle</button>
      </div>
    </div>
  </div>
</div>  

{% endif %}
</div>

<!-- =================== SCRIPTS =================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("== provisioning dashboard script STARTED ==");

  // === –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ===
  let selectedPhoneId = null;
  let selectedPhoneMac = '';
  let selectedPhoneIp = '';
  let selectedPhoneModel = '';

  // === –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è MAC-–∞–¥—Ä–µ—Å–∞ ===
  const configSelectedMac = document.getElementById("config-selected-mac");
  const sipSelectedMac = document.getElementById("sip-selected-mac");

  // === –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ===
  function updateSelectedPhone() {
    const selectedRadio = document.querySelector('input[name="selected_phone"]:checked');
    if (selectedRadio) {
      const row = selectedRadio.closest('.sip-phone-row');
      selectedPhoneId = row.dataset.eqid;
      selectedPhoneMac = row.dataset.mac || '‚Äî';
      selectedPhoneIp = row.dataset.ip || '';
      selectedPhoneModel = row.dataset.model || '';

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ MAC-–∞–¥—Ä–µ—Å–∞
      configSelectedMac.textContent = selectedPhoneMac;
      sipSelectedMac.textContent = selectedPhoneMac;

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å—Ç—Ä–æ–∫
      document.querySelectorAll('.sip-phone-row').forEach(row => {
        row.classList.remove('selected-phone', 'bg-blue-50');
      });
      row.classList.add('selected-phone', 'bg-blue-50');
    }
  }

  // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ===
  document.querySelectorAll('.phone-selector').forEach(radio => {
    radio.addEventListener('change', updateSelectedPhone);
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  updateSelectedPhone();

  // === üîê CSRF ===
  function getCookie(name) {
    const cookies = document.cookie.split(";").map(c => c.trim());
    for (let cookie of cookies) {
      if (cookie.startsWith(name + "=")) return decodeURIComponent(cookie.split("=")[1]);
    }
    return null;
  }
  const csrftoken = getCookie('csrftoken');

  // === ‚öôÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è) ===
  document.getElementById("generate-btn").addEventListener("click", async () => {
    const employeeId = document.getElementById("employee-select").value;
    if (!employeeId) {
      document.getElementById("config-output").value = "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.";
      return;
    }

    if (!selectedPhoneId) {
      document.getElementById("config-output").value = "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ SIP-—Ç–µ–ª–µ—Ñ–æ–Ω.";
      return;
    }

    document.getElementById("config-output").value = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞...";
    document.getElementById("save-btn").classList.add("hidden");

    try {
      const resp = await fetch("{% url 'generate_config' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        body: new URLSearchParams({ 
          employee_id: employeeId,
          equipment_id: selectedPhoneId 
        })
      });
      const data = await resp.json();
      if (data.success) {
        currentConfig = data.config;
        currentFilename = data.filename;
        document.getElementById("config-output").value = data.config;
        document.getElementById("save-btn").classList.remove("hidden");
      } else {
        document.getElementById("config-output").value = "‚ùå " + (data.message || "–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞.");
      }
    } catch(e) {
      document.getElementById("config-output").value = "‚ö†Ô∏è –û—à–∏–±–∫–∞: " + e.message;
    }
  });

// === üíæ –ü—Ä–æ—Å—Ç–æ–µ –∏ —á–µ—Å—Ç–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===
document.getElementById("save-btn").addEventListener("click", () => {
    if (!currentConfig) {
        alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.");
        return;
    }

    // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    const blob = new Blob([currentConfig], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = currentFilename;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // –ß–µ—Å—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, –∫—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è —Ñ–∞–π–ª
    alert(`‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\n\n` +
          `–§–∞–π–ª: ${currentFilename}\n` +
          `–°–æ—Ö—Ä–∞–Ω–µ–Ω –≤: –ü–∞–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∫–∏"\n\n` +
          `–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ TFTP —Å–µ—Ä–≤–µ—Ä–µ:\n` +
          `–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –≤: Z:\\TEST\\\n` +
          `TFTP –ø—É—Ç—å: tftp://172.16.15.225/TEST/${currentFilename}`);
});


  // === üì∑ –ó–∞–≥—Ä—É–∑–∫–∞/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ SIP (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è) ===
  async function updateSipScreen() {
    const employeeId = document.getElementById("employee-select").value;
    if (!employeeId || !selectedPhoneId) {
      alert("‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ SIP-—Ç–µ–ª–µ—Ñ–æ–Ω.");
      return;
    }

    try {
      const resp = await fetch(`/provisioning/sip_screen/?employee_id=${employeeId}&equipment_id=${selectedPhoneId}`);
      const data = await resp.json();
      if (data.success) {
        document.getElementById("sip-screen-img").src = data.image_url + "?t=" + Date.now();
        document.getElementById("sip-screen-section").classList.remove("hidden");
      } else {
        alert("‚ö†Ô∏è " + data.message);
      }
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ SIP:", e);
    }
  }

  document.getElementById("btn-sip-screen").addEventListener("click", updateSipScreen);

  // === üéõ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –Ω–∞ SIP (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è) ===
  document.querySelectorAll(".sip-cmd").forEach(btn => {
    btn.addEventListener("click", async () => {
      const cmd = btn.dataset.cmd;
      const employeeId = document.getElementById("employee-select").value;
      
      if (!employeeId || !selectedPhoneId) {
        alert("‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ SIP-—Ç–µ–ª–µ—Ñ–æ–Ω.");
        return;
      }

      try {
        const resp = await fetch(`/provisioning/send_sip_command/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrftoken },
          body: new URLSearchParams({
            employee_id: employeeId,
            equipment_id: selectedPhoneId,
            cmd: cmd,
            login: document.getElementById("sip-login").value,
            password: document.getElementById("sip-password").value,
          }),
        });
        const data = await resp.json();
        // üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
        await updateSipScreen();
      } catch(e) {
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã: " + e.message);
      }
    });
  });

  // === Inline Edit —Ç–∞–±–ª–∏—Ü—ã SIP (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ===
  const table = document.getElementById('sip-table');
  if (table) {
      table.querySelectorAll('tbody tr').forEach(row => {
          const editBtn = row.querySelector('.btn-edit');
          const saveBtn = row.querySelector('.btn-save');
          const cancelBtn = row.querySelector('.btn-cancel');
          const successMsg = row.querySelector('.success-msg');
          const errorMsg = row.querySelector('.error-msg');

          const cells = {
              model: row.querySelector('.model-cell'),
              serial_number: row.querySelector('.serial-cell'),
              mac_address: row.querySelector('.mac-cell'),
              ip_or_anydesk: row.querySelector('.ip-cell'),
          };

          let originalValues = {};

          function enterEditMode() {
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
              originalValues = {};
              for (const key in cells) {
                  const view = cells[key].querySelector('.view');
                  const input = cells[key].querySelector('.edit');
                  originalValues[key] = view.textContent.trim();
                  
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º input, —Å–∫—Ä—ã–≤–∞–µ–º view
                  if (view) view.classList.add('hidden');
                  if (input) {
                      input.classList.remove('hidden');
                      input.value = originalValues[key] === '‚Äî' ? '' : originalValues[key];
                  }
              }

              // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
              editBtn.classList.add('hidden');
              saveBtn.classList.remove('hidden');
              cancelBtn.classList.remove('hidden');
              successMsg.classList.add('hidden');
              errorMsg.classList.add('hidden');
          }

          function exitEditMode(restore = false) {
              for (const key in cells) {
                  const view = cells[key].querySelector('.view');
                  const input = cells[key].querySelector('.edit');
                  
                  if (restore) {
                      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                      if (view) view.textContent = originalValues[key];
                      if (input) input.value = originalValues[key] === '‚Äî' ? '' : originalValues[key];
                  }
                  
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º view, —Å–∫—Ä—ã–≤–∞–µ–º input
                  if (view) view.classList.remove('hidden');
                  if (input) input.classList.add('hidden');
              }

              // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
              editBtn.classList.remove('hidden');
              saveBtn.classList.add('hidden');
              cancelBtn.classList.add('hidden');
              successMsg.classList.add('hidden');
              errorMsg.classList.add('hidden');
          }

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
          editBtn.addEventListener('click', (e) => {
              e.preventDefault();
              enterEditMode();
          });

          cancelBtn.addEventListener('click', (e) => {
              e.preventDefault();
              exitEditMode(true); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
          });

          saveBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
              saveBtn.disabled = true;
              saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
              errorMsg.classList.add('hidden');

              try {
                  const eqId = row.dataset.eqid;
                  const formData = new FormData();
                  formData.append('id', eqId);

                  // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
                  for (const key in cells) {
                      const input = cells[key].querySelector('.edit');
                      formData.append(key, input ? input.value.trim() : '');
                  }

                  const resp = await fetch('{% url "update_equipment_inline" %}', {
                      method: 'POST',
                      headers: { 'X-CSRFToken': csrftoken },
                      body: formData
                  });

                  const data = await resp.json();

                  if (data.success) {
                      // –û–±–Ω–æ–≤–ª—è–µ–º view —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                      for (const key in data.updated) {
                          const view = cells[key].querySelector('.view');
                          const value = data.updated[key] || '‚Äî';
                          if (view) view.textContent = value;
                      }

                      successMsg.classList.remove('hidden');
                      setTimeout(() => {
                          exitEditMode(false); // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                      }, 1000);
                  } else {
                      errorMsg.textContent = data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
                      errorMsg.classList.remove('hidden');
                  }
              } catch (error) {
                  errorMsg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
                  errorMsg.classList.remove('hidden');
              } finally {
                  saveBtn.disabled = false;
                  saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
              }
          });
      });
  }
  console.log("== provisioning dashboard script FINISHED ==");
});
</script>

<style>
.selected-phone {
  background-color: #eff6ff !important;
  border-left: 4px solid #3b82f6;
}

.sip-phone-row {
  transition: background-color 0.2s ease;
}

.sip-phone-row:hover {
  background-color: #f9fafb;
}
</style>
{% endblock %}