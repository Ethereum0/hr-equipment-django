<!-- templates/staff/base.html -->

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>HR & Equipment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Heroicons –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-gray-50">
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –≤–∏–¥–µ –∑–∞–∫–ª–∞–¥–æ–∫ (—Ç–∞–±–æ–≤) -->
  <div class="border-b border-gray-100">
    <nav class="container mx-auto px-2 -mb-px flex flex-wrap" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <a href="{% url 'dashboard' %}" class="inline-block py-4 px-6 text-center border-b-2 font-medium text-sm {% if request.resolver_match.url_name == 'dashboard' %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
        –ì–ª–∞–≤–Ω–∞—è
      </a>
      <a href="{% url 'employees_list' %}" class="inline-block py-4 px-6 text-center border-b-2 font-medium text-sm {% if request.resolver_match.url_name == 'employees_list' %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
        –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
      </a>
      <a href="{% url 'equipment_list' %}" class="inline-block py-4 px-6 text-center border-b-2 font-medium text-sm {% if request.resolver_match.url_name == 'equipment_list' %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
        –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
      </a>
      <!-- ‚úÖ –ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ Provisioning -->
      <a href="{% url 'provisioning_dashboard' %}" class="inline-block py-4 px-6 text-center border-b-2 font-medium text-sm {% if request.resolver_match.url_name == 'provisioning_dashboard' %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
        Provisioning
      </a>
      <a href="/admin/" class="inline-block py-4 px-6 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
        –ê–¥–º–∏–Ω–∫–∞
      </a>
    </nav>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
  <div class="container mx-auto px-1 py-1">
    {% block content %}{% endblock %}
  </div>

  {% block extra_js %}{% endblock %}

<div id="notifications-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm"></div>

<script>
// –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫—Ä—ã—Ç—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ localStorage
const getClosedNotifications = () => {
    try {
        return new Set(JSON.parse(localStorage.getItem('closedNotifications') || '[]'));
    } catch {
        return new Set();
    }
};

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫—Ä—ã—Ç—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ localStorage
const saveClosedNotification = (notificationId) => {
    const closed = getClosedNotifications();
    closed.add(notificationId);
    localStorage.setItem('closedNotifications', JSON.stringify([...closed]));
};

const closedNotifications = getClosedNotifications();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(notification) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∏ –ª–∏ —É–∂–µ —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if (closedNotifications.has(notification.id)) {
        return; // –£–∂–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    }
    
    const container = document.getElementById('notifications-container');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if (document.getElementById(`notification-${notification.id}`)) {
        return; // –£–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    }
    
    const notificationEl = document.createElement('div');
    notificationEl.id = `notification-${notification.id}`;
    notificationEl.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative shadow-lg';
    notificationEl.innerHTML = `
        <strong>üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å</strong>
        <p class="text-sm mt-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${notification.employee_name}</p>
        <p class="text-xs text-gray-600">–õ–æ–≥–∏–Ω: ${notification.username}</p>
        <p class="text-xs text-gray-600">–í—Ä–µ–º—è: ${new Date(notification.timestamp).toLocaleTimeString()}</p>
        ${notification.employee_id ? 
            `<button onclick="openEmployeeCard(${notification.employee_id}, '${notification.id}')" 
                    class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
            </button>` 
            : ''
        }
        <button onclick="closeNotification('${notification.id}')" 
                class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
            √ó
        </button>
    `;
    
    container.appendChild(notificationEl);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function closeNotification(notificationId) {
    const notificationEl = document.getElementById(`notification-${notificationId}`);
    if (notificationEl) {
        notificationEl.remove();
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ
    saveClosedNotification(notificationId);
    
    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–∑ –∫—ç—à–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    fetch('/staff/remove-notification/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({ notification_id: notificationId })
    }).catch(error => console.error('Remove notification failed:', error));
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ
function openEmployeeCard(employeeId, notificationId) {
    // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notificationEl = document.getElementById(`notification-${notificationId}`);
    if (notificationEl) {
        notificationEl.remove();
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ
    saveClosedNotification(notificationId);
    
    // –ù–ï–ú–ï–î–õ–ï–ù–ù–û –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–Ω–µ –∂–¥–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
    window.location.href = `/employees/?selected_id=${employeeId}`;
    
    // –í —Ñ–æ–Ω–µ —É–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–∑ –∫—ç—à–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥)
    fetch('/remove-notification/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({ notification_id: notificationId })
    }).catch(error => console.error('Remove notification failed:', error));
}
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
function checkForNotifications() {
    fetch('/staff/check-notifications/')
        .then(r => r.json())
        .then(data => {
            if (data.notifications && data.notifications.length > 0) {
                data.notifications.forEach(notification => {
                    showNotification(notification);
                });
            }
        })
        .catch(error => console.error('Notification check failed:', error));
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
setInterval(checkForNotifications, 5000);
checkForNotifications();
</script>
</body>
</html>