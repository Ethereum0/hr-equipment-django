{% extends 'staff/base.html' %}
{% load staff_extras %}
{% block content %}

<h2 class="text-xl font-bold mb-4">
  {% if form.instance.pk %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å{% else %}–î–æ–±–∞–≤–∏—Ç—å{% endif %} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
</h2>

<!-- Sticky –∫–Ω–æ–ø–∫–∏ —Å–≤–µ—Ä—Ö—É -->
<div class="flex gap-3 justify-end sticky top-0 z-50 bg-white p-2 border-b">
  <div id="save_message" class="text-sm mt-2"></div>
  <button type="button" id="save-btn" class="px-4 py-2 bg-blue-600 text-white rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button type="button" id="settings-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
      ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
  </button>
  <button type="button" id="close-btn" class="px-4 py-2 bg-gray-200 rounded text-gray-700">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>


<form method="post" id="employee-form">
  {% csrf_token %}
  <div class="grid grid-cols-4 gap-4 mt-2">

    <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê 1/4: –§–æ—Ç–æ + –°—Ç–∞—Ç—É—Å + –§–ò–û -->
    <div class="col-span-1 flex flex-col gap-4">
      <fieldset class="border p-4 flex-1">
        <legend class="font-medium">–§–æ—Ç–æ –∏ —Å—Ç–∞—Ç—É—Å</legend>
        <div class="flex flex-col items-center">
          {% if form.instance.ad_login %}
            {% if form.instance.email %}
              {% with photo_url="https://p-el.ru/mail-photos/"|add:form.instance.email|add:".jpg" %}
                <img src="{{ photo_url }}" alt="–§–æ—Ç–æ {{ form.instance.fio }}" class="w-32 h-32 object-cover rounded mb-3" onerror="this.onerror=null;this.src='/static/images/no-photo-icon.png';">
              {% endwith %}
            {% else %}
              {% with photo_url="https://p-el.ru/mail-photos/"|add:form.instance.ad_login|add:"@p-el.ru.jpg" %}
                <img src="{{ photo_url }}" alt="–§–æ—Ç–æ {{ form.instance.fio }}" class="w-32 h-32 object-cover rounded mb-3" onerror="this.onerror=null;this.src='/static/images/no-photo-icon.png';">
              {% endwith %}
            {% endif %}
          {% else %}
            <div class="w-32 h-32 bg-gray-200 rounded mb-3 flex items-center justify-center">
              <span class="text-xs text-gray-500">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
            </div>
          {% endif %}

          <!-- –§–ò–û -->
          <div class="w-full mt-2">
            <label class="text-xs text-gray-600">–§–ò–û</label>
            <input type="text" id="fio_field" name="fio" class="w-full px-2 py-1 border rounded" value="{% if form.instance.last_name %}{{ form.instance.last_name }} {% endif %}{% if form.instance.first_name %}{{ form.instance.first_name }} {% endif %}{% if form.instance.middle_name %}{{ form.instance.middle_name }}{% endif %}">
          </div>

          <!-- –°—Ç–∞—Ç—É—Å -->
          <div class="mt-3 w-full">
            <label class="text-xs text-gray-600">–°—Ç–∞—Ç—É—Å</label>
            {{ form.status|add_class:"w-full px-2 py-1 rounded text-xs" }}
          </div>

          <!-- SIP readonly -->
          <div class="mt-3 w-full">
            <label class="text-xs text-gray-600">–ù–æ–º–µ—Ä SIP</label>
            <span id="sip_preview" class="block px-2 py-1 text-gray-700">{{ form.sip_number.value }}</span>
          </div>
        </div>
      </fieldset>
    </div>

    <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê 3/4: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
    <div class="col-span-3 flex flex-col gap-4">

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <fieldset class="border p-4">
        <legend class="font-medium">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</legend>
        <div class="grid grid-cols-3 gap-2">
          <div>
            <label class="text-sm text-gray-600">First name</label>
            {{ form.first_name|add_class:"w-full px-2 py-1 border rounded" }}
          </div>
          <div>
            <label class="text-sm text-gray-600">Last name</label>
            {{ form.last_name|add_class:"w-full px-2 py-1 border rounded" }}
          </div>
          <div>
            <label class="text-sm text-gray-600">Middle name</label>
            {{ form.middle_name|add_class:"w-full px-2 py-1 border rounded" }}
          </div>
          <div>
            <label class="text-sm text-gray-600">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            {{ form.phone|add_class:"w-full px-2 py-1 border rounded" }}
          </div>
          <div>
            <label class="text-sm text-gray-600">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
            {{ form.position|add_class:"w-full px-2 py-1 border rounded" }}
          </div>
          <div>
            <label class="text-sm text-gray-600">–û—Ç–¥–µ–ª</label>
            {{ form.department|add_class:"w-full px-2 py-1 border rounded" }}
          </div>
          <div>
            <label class="text-sm text-gray-600">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</label>
            {{ form.supervisor|add_class:"w-full px-2 py-1 border rounded" }}
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-sm text-gray-600">–û—Ñ–∏—Å</label>
              {{ form.office|add_class:"w-full px-2 py-1 border rounded" }}
            </div>
            <div>
              <label class="text-sm text-gray-600">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</label>
              {{ form.hire_date|add_class:"w-full px-2 py-1 border rounded" }}
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600">–î–∞—Ç–∞ —É–≤–æ–ª—å–Ω–µ–Ω–∏—è</label>
            {{ form.dismissal_date|add_class:"w-full px-2 py-1 border rounded" }}
          </div>
        </div>
      </fieldset>

      <!-- –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
      <fieldset class="border p-4">
        <legend class="font-medium">–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ)</legend>
        <div class="grid grid-cols-6 gap-3">

          <!-- AD -->
          <div class="border rounded-lg p-3 bg-blue-50 border-blue-200">
            <h3 class="text-sm font-medium text-blue-800 mb-2">AD</h3>
            <div class="space-y-2">
              <div>
                <label class="text-xs text-gray-500">–õ–æ–≥–∏–Ω</label>
                <input type="text" id="ad_login_field" name="{{ form.ad_login.html_name }}" value="{{ form.ad_login.value|default_if_none:'' }}" class="w-full px-2 py-1 border rounded" oninput="updateADPrefix()">
              </div>
              <div class="password-field-wrapper">
                <div class="password-field">
                  <label class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</label>
                  <input type="text" name="{{ form.ad_password.html_name }}" value="{{ form.ad_password.value|default_if_none:'' }}" class="w-full px-2 py-1 border rounded" id="id_ad_password" />
                </div>
                <div class="password-controls">
                  <button type="button" class="password-generate" onclick="generateMasterPassword()" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª–∏">
                    üé≤
                  </button>
                  <div class="password-strength" id="id_ad_password-strength"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Email -->
          <div class="border rounded-lg p-3 bg-green-50 border-green-200">
            <h3 class="text-sm font-medium text-green-800 mb-2">Email</h3>
            <div class="space-y-2">
              <div>
                <label class="text-xs text-gray-500">Email</label>
                {{ form.email|add_class:"w-full px-2 py-1 border rounded" }}
              </div>
              <div class="password-field-wrapper">
                <div class="password-field">
                  <label class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</label>
                  <input type="text" name="{{ form.email_password.html_name }}" value="{{ form.email_password.value|default_if_none:'' }}" class="w-full px-2 py-1 border rounded" id="id_email_password" />
                </div>
                <div class="password-controls">
                  <button type="button" class="password-generate" onclick="generatePassword('id_email_password')">
                    üé≤
                  </button>
                  <div class="password-strength" id="id_email_password-strength"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- SIP / 3CX -->
          <div class="border rounded-lg p-3 bg-purple-50 border-purple-200">
            <h3 class="text-sm font-medium text-purple-800 mb-2">SIP / 3CX</h3>
            <div class="space-y-2">
              <div>
                <label class="text-xs text-gray-500">–ù–æ–º–µ—Ä SIP</label>
                {{ form.sip_number|add_class:"w-full px-2 py-1 border rounded" }}
              </div>
              <div class="password-field-wrapper">
                <div class="password-field">
                  <label class="text-xs text-gray-500">3CX WEB –ø–∞—Ä–æ–ª—å</label>
                  <input type="text" name="{{ form.web_3cx.html_name }}" value="{{ form.web_3cx.value|default_if_none:'' }}" class="w-full px-2 py-1 border rounded" id="id_web_3cx" />
                </div>
                <div class="password-controls">
                  <button type="button" class="password-generate" onclick="generatePassword('id_web_3cx')">
                    üé≤
                  </button>
                  <div class="password-strength" id="id_web_3cx-strength"></div>
                </div>
              </div>
              <div class="password-field-wrapper">
                <div class="password-field">
                  <label class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å 3CX</label>
                  <input type="text" name="{{ form.pass_3cx.html_name }}" value="{{ form.pass_3cx.value|default_if_none:'' }}" class="w-full px-2 py-1 border rounded" id="id_pass_3cx" />
                </div>
                <div class="password-controls">
                  <button type="button" class="password-generate" onclick="generatePassword('id_pass_3cx')">
                    üé≤
                  </button>
                  <div class="password-strength" id="id_pass_3cx-strength"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- –ë24 -->
          <div class="border rounded-lg p-3 bg-amber-50 border-amber-200">
            <h3 class="text-sm font-medium text-amber-800 mb-2">–ë24</h3>
            <div class="space-y-2">
              <div>
                <label class="text-xs text-gray-500">–õ–æ–≥–∏–Ω</label>
                {{ form.b24_login|add_class:"w-full px-2 py-1 border rounded" }}
              </div>
              <div class="password-field-wrapper">
                <div class="password-field">
                  <label class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</label>
                  <input type="text" name="{{ form.b24_password.html_name }}" value="{{ form.b24_password.value|default_if_none:'' }}" class="w-full px-2 py-1 border rounded" id="id_b24_password" />
                </div>
                <div class="password-controls">
                  <button type="button" class="password-generate" onclick="generatePassword('id_b24_password')">
                    üé≤
                  </button>
                  <div class="password-strength" id="id_b24_password-strength"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- –¢–µ–ª–µ—Ñ–æ–Ω–∏—è –ë24 -->
          <div class="border rounded-lg p-3 bg-cyan-50 border-cyan-200">
            <h3 class="text-sm font-medium text-cyan-800 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω–∏—è –ë24</h3>
            <div class="space-y-2">
              <div>
                <label class="text-xs text-gray-500">–õ–æ–≥–∏–Ω</label>
                {{ form.tel_b24_login|add_class:"w-full px-2 py-1 border rounded" }}
              </div>
              <div class="password-field-wrapper">
                <div class="password-field">
                  <label class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</label>
                  <input type="text" name="{{ form.tel_b24_password.html_name }}" value="{{ form.tel_b24_password.value|default_if_none:'' }}" class="w-full px-2 py-1 border rounded" id="id_tel_b24_password" />
                </div>
                <div class="password-controls">
                  <button type="button" class="password-generate" onclick="generatePassword('id_tel_b24_password')">
                    üé≤
                  </button>
                  <div class="password-strength" id="id_tel_b24_password-strength"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- –í–ê–¢–° -->
          <div class="border rounded-lg p-3 bg-red-50 border-red-200">
            <h3 class="text-sm font-medium text-red-800 mb-2">–í–ê–¢–°</h3>
            <div class="space-y-2">
              <div>
                <label class="text-xs text-gray-500">–õ–æ–≥–∏–Ω</label>
                {{ form.vats_login|add_class:"w-full px-2 py-1 border rounded" }}
              </div>
              <div class="password-field-wrapper">
                <div class="password-field">
                  <label class="text-xs text-gray-500">–ü–∞—Ä–æ–ª—å</label>
                  <input type="text" name="{{ form.vats_password.html_name }}" value="{{ form.vats_password.value|default_if_none:'' }}" class="w-full px-2 py-1 border rounded" id="id_vats_password" />
                </div>
                <div class="password-controls">
                  <button type="button" class="password-generate" onclick="generatePassword('id_vats_password')">
                    üé≤
                  </button>
                  <div class="password-strength" id="id_vats_password-strength"></div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </fieldset>
    </div>
  </div>

  <!-- –î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <fieldset class="border p-4 mt-4">
    <legend class="font-medium">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</legend>
    {{ form.info|add_class:"w-full px-2 py-2 border rounded resize-y min-h-[40px]" }}
  </fieldset>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø–∞—Ä–æ–ª–µ–π -->
  <div id="settings-modal" class="settings-modal">
      <div class="settings-content">
          <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø–∞—Ä–æ–ª–µ–π</h3>
              <button type="button" id="modal-close-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          
          <div class="settings-option">
              <label>–î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è: <span id="length-value">12</span> —Å–∏–º–≤–æ–ª–æ–≤</label>
              <input type="range" id="password-length" min="8" max="20" value="12" class="w-full" oninput="updateLengthValue(this.value)">
          </div>
          
          <div class="settings-option">
              <label>
                  <input type="checkbox" id="use-uppercase" checked> –ó–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã (A-Z)
              </label>
          </div>
          
          <div class="settings-option">
              <label>
                  <input type="checkbox" id="use-lowercase" checked> –°—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã (a-z)
              </label>
          </div>
          
          <div class="settings-option">
              <label>
                  <input type="checkbox" id="use-numbers" checked> –¶–∏—Ñ—Ä—ã (0-9)
              </label>
          </div>
          
          <div class="settings-option">
              <label>
                  <input type="checkbox" id="use-symbols" checked> –°–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã (!@#$%^&*)
              </label>
          </div>
          
          <div class="settings-option">
              <label>
                  <input type="checkbox" id="sync-passwords" checked> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª–∏ AD ‚Üí Email ‚Üí –ë24
              </label>
          </div>
          
          <div class="settings-option">
              <label>–ò—Å–∫–ª—é—á–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ —Å–∏–º–≤–æ–ª—ã:</label>
              <input type="text" id="exclude-chars" value="" placeholder="oO0l1iI" class="w-full p-2 border rounded">
          </div>
          
          <div class="mt-6 flex gap-2">
              <button type="button" id="modal-apply-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                  –ü—Ä–∏–º–µ–Ω–∏—Ç—å
              </button>
              <button type="button" id="modal-close-btn2" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                  –ó–∞–∫—Ä—ã—Ç—å
              </button>
              <button type="button" id="modal-reset-btn" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                  –°–±—Ä–æ—Å–∏—Ç—å
              </button>
          </div>
      </div>
  </div>

</form>

<script>
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø–∞—Ä–æ–ª–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
let passwordSettings = {
    length: 12,
    useUppercase: true,
    useLowercase: true,
    useNumbers: true,
    useSymbols: true,
    excludeChars: '',
    syncPasswords: true
};

// –°–ø–∏—Å–∫–∏ —Å–ª–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–∏—Ç–∞–µ–º—ã—Ö –ø–∞—Ä–æ–ª–µ–π
const readableWords = {
    prefixes: ['Syv', 'Nez', 'Bok', 'Gor', 'Dre', 'Fal', 'Kir', 'Lom', 'Pyr', 'Rav'],
    syllables: ['bis', 'reg', 'gob', 'vid', 'tor', 'nal', 'mer', 'siv', 'tan', 'vol'],
    suffixes: ['ide', 'obo', 'ara', 'ito', 'une', 'ega', 'oro', 'ima', 'ulo', 'ane']
};

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function openSettings() {
    console.log('Opening settings modal');
    document.getElementById('settings-modal').style.display = 'block';
    loadSettings();
}

function closeSettings() {
    console.log('Closing settings modal');
    document.getElementById('settings-modal').style.display = 'none';
}

function updateLengthValue(value) {
    document.getElementById('length-value').textContent = value;
}

function loadSettings() {
    console.log('Loading settings:', passwordSettings);
    document.getElementById('password-length').value = passwordSettings.length;
    document.getElementById('use-uppercase').checked = passwordSettings.useUppercase;
    document.getElementById('use-lowercase').checked = passwordSettings.useLowercase;
    document.getElementById('use-numbers').checked = passwordSettings.useNumbers;
    document.getElementById('use-symbols').checked = passwordSettings.useSymbols;
    document.getElementById('sync-passwords').checked = passwordSettings.syncPasswords;
    document.getElementById('exclude-chars').value = passwordSettings.excludeChars;
    updateLengthValue(passwordSettings.length);
}

function applySettings() {
    console.log('Applying settings');
    passwordSettings = {
        length: parseInt(document.getElementById('password-length').value),
        useUppercase: document.getElementById('use-uppercase').checked,
        useLowercase: document.getElementById('use-lowercase').checked,
        useNumbers: document.getElementById('use-numbers').checked,
        useSymbols: document.getElementById('use-symbols').checked,
        syncPasswords: document.getElementById('sync-passwords').checked,
        excludeChars: document.getElementById('exclude-chars').value
    };
    console.log('New settings:', passwordSettings);
    closeSettings();
    localStorage.setItem('passwordGeneratorSettings', JSON.stringify(passwordSettings));
}

function resetSettings() {
    console.log('Resetting settings to default');
    passwordSettings = {
        length: 12,
        useUppercase: true,
        useLowercase: true,
        useNumbers: true,
        useSymbols: true,
        syncPasswords: true,
        excludeChars: ''
    };
    loadSettings();
}

// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —á–∏—Ç–∞–µ–º—ã—Ö –ø–∞—Ä–æ–ª–µ–π —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –¥–ª–∏–Ω–æ–π
function generateReadablePassword() {
    const prefix = readableWords.prefixes[Math.floor(Math.random() * readableWords.prefixes.length)];
    const syllable = readableWords.syllables[Math.floor(Math.random() * readableWords.syllables.length)];
    const suffix = readableWords.suffixes[Math.floor(Math.random() * readableWords.suffixes.length)];
    
    // –°–æ–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤—É –ø–∞—Ä–æ–ª—è
    let passwordBase = prefix + syllable + suffix;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã
    const baseLength = passwordBase.length;
    const remainingLength = passwordSettings.length - baseLength;
    
    let additionalChars = '';
    
    if (remainingLength > 0) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)
        const numbersLength = Math.max(2, Math.min(remainingLength - 1, 4));
        const numbers = Math.floor(Math.pow(10, numbersLength - 1) + Math.random() * (Math.pow(10, numbersLength) - Math.pow(10, numbersLength - 1))).toString();
        
        additionalChars = numbers;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ
        if (passwordSettings.useSymbols && additionalChars.length < remainingLength) {
            const symbols = '@$!%*?&';
            const symbol = symbols[Math.floor(Math.random() * symbols.length)];
            additionalChars += symbol;
        }
        
        // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –º–µ—Å—Ç–æ, –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        if (additionalChars.length < remainingLength) {
            const extraLength = remainingLength - additionalChars.length;
            const extraChars = 'abcdefghijkmnpqrstuvwxyz';
            for (let i = 0; i < extraLength; i++) {
                additionalChars += extraChars[Math.floor(Math.random() * extraChars.length)];
            }
        }
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å
    let password = passwordBase + additionalChars;
    
    // –û–±—Ä–µ–∑–∞–µ–º –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    password = password.substring(0, passwordSettings.length);
    
    console.log('Generated readable password:', password, 'Length:', password.length);
    return password;
}

// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
function generatePassword(fieldId) {
    console.log('Generating password for:', fieldId, 'with length:', passwordSettings.length);
    let password;
    
    if (passwordSettings.useUppercase && passwordSettings.useLowercase && 
        passwordSettings.useNumbers && passwordSettings.useSymbols) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Ç–∞–µ–º—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –µ—Å–ª–∏ –≤—Å–µ –æ–ø—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω—ã
        password = generateReadablePassword();
    } else {
        // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
        password = generateStandardPassword();
    }
    
    document.getElementById(fieldId).value = password;
    updatePasswordStrength(fieldId, password);
    console.log('Generated password:', password, 'Actual length:', password.length);
}

// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π
function generateStandardPassword() {
    const charset = {
        uppercase: 'ABCDEFGHJKLMNPQRSTUVWXYZ',
        lowercase: 'abcdefghijkmnpqrstuvwxyz',
        numbers: '23456789',
        symbols: '@$!%*?&'
    };
    
    let availableChars = '';
    
    if (passwordSettings.useUppercase) availableChars += charset.uppercase;
    if (passwordSettings.useLowercase) availableChars += charset.lowercase;
    if (passwordSettings.useNumbers) availableChars += charset.numbers;
    if (passwordSettings.useSymbols) availableChars += charset.symbols;
    
    // –ò—Å–∫–ª—é—á–∞–µ–º —Å–∏–º–≤–æ–ª—ã
    if (passwordSettings.excludeChars) {
        availableChars = availableChars.split('').filter(char => 
            !passwordSettings.excludeChars.includes(char)
        ).join('');
    }
    
    if (availableChars.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø —Å–∏–º–≤–æ–ª–æ–≤!');
        return '';
    }
    
    let password = '';
    for (let i = 0; i < passwordSettings.length; i++) {
        const randomIndex = Math.floor(Math.random() * availableChars.length);
        password += availableChars[randomIndex];
    }
    
    console.log('Generated standard password:', password, 'Length:', password.length);
    return password;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—è —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
function generateMasterPassword() {
    console.log('Generating master password with sync:', passwordSettings.syncPasswords, 'Length:', passwordSettings.length);
    const masterPassword = generateReadablePassword();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å –¥–ª—è AD
    document.getElementById('id_ad_password').value = masterPassword;
    updatePasswordStrength('id_ad_password', masterPassword);
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è
    if (passwordSettings.syncPasswords) {
        document.getElementById('id_email_password').value = masterPassword;
        document.getElementById('id_b24_password').value = masterPassword;
        
        updatePasswordStrength('id_email_password', masterPassword);
        updatePasswordStrength('id_b24_password', masterPassword);
        
        console.log('Passwords synchronized to Email and –ë24');
    }
    
    console.log('Master password generated:', masterPassword, 'Length:', masterPassword.length);
}

// –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
function updatePasswordStrength(fieldId, password) {
    const strengthElement = document.getElementById(fieldId + '-strength');
    if (!strengthElement) return;
    
    let strength = 0;
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    let strengthText = '';
    let strengthClass = '';
    
    if (strength <= 2) {
        strengthText = '–°–ª–∞–±—ã–π';
        strengthClass = 'strength-weak';
    } else if (strength <= 4) {
        strengthText = '–°—Ä–µ–¥–Ω–∏–π';
        strengthClass = 'strength-medium';
    } else {
        strengthText = '–°–∏–ª—å–Ω—ã–π';
        strengthClass = 'strength-strong';
    }
    
    strengthElement.textContent = strengthText;
    strengthElement.className = 'password-strength ' + strengthClass;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing password generator');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ localStorage
    try {
        const savedSettings = localStorage.getItem('passwordGeneratorSettings');
        if (savedSettings) {
            passwordSettings = JSON.parse(savedSettings);
            console.log('Loaded settings from localStorage:', passwordSettings);
        } else {
            console.log('No saved settings, using defaults');
        }
    } catch (e) {
        console.error('Error loading settings from localStorage:', e);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ—Ä–º—ã
    const form = document.getElementById("employee-form");
    const saveBtn = document.getElementById("save-btn");
    const closeBtn = document.getElementById("close-btn");
    const settingsBtn = document.getElementById("settings-btn");

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    let initialData = new FormData(form);

    function isFormChanged() {
        const currentData = new FormData(form);
        for (let [key, value] of currentData.entries()) {
            if (value !== initialData.get(key)) return true;
        }
        return false;
    }

    function updateSaveButton() {
        if (isFormChanged()) {
            saveBtn.classList.add("bg-green-600", "font-bold");
            saveBtn.classList.remove("bg-blue-600");
        } else {
            saveBtn.classList.remove("bg-green-600", "font-bold");
            saveBtn.classList.add("bg-blue-600");
        }
    }

    // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ñ–æ—Ä–º–µ
    form.addEventListener("input", updateSaveButton);

    // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É
    closeBtn.addEventListener("click", function() {
        if (isFormChanged()) {
            if (!confirm("–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ó–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É?")) return;
        }
        window.location.href = "{% url 'employees_list' %}";
    });

    // –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    settingsBtn.addEventListener("click", openSettings);

    // AJAX —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    saveBtn.addEventListener("click", function() {
        const msg = document.getElementById("save_message");

        const xhr = new XMLHttpRequest();
        xhr.open("POST", window.location.href);
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhr.setRequestHeader("X-CSRFToken", document.querySelector('[name=csrfmiddlewaretoken]').value);

        xhr.onload = function() {
            if (xhr.status === 200) {
                msg.textContent = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ";
                msg.className = "text-green-900 text-sm mt-3";

                // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ "–∏—Å—Ö–æ–¥–Ω—ã–µ"
                initialData = new FormData(form);
                updateSaveButton();

                setTimeout(() => { msg.textContent = ""; }, 3000);

            } else {
                msg.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è";
                msg.className = "text-red-600 text-sm mt-2";
            }
        };

        xhr.send(new FormData(form));
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('modal-close-btn').addEventListener('click', closeSettings);
    document.getElementById('modal-close-btn2').addEventListener('click', closeSettings);
    document.getElementById('modal-apply-btn').addEventListener('click', applySettings);
    document.getElementById('modal-reset-btn').addEventListener('click', resetSettings);
    
    // –û—Ü–µ–Ω–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–æ–ª–∏
    const passwordFields = [
        'id_ad_password', 'id_email_password', 'id_web_3cx', 
        'id_pass_3cx', 'id_b24_password', 'id_tel_b24_password', 'id_vats_password'
    ];
    passwordFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.value) {
            updatePasswordStrength(fieldId, field.value);
        }
    });

    // –§–ò–û –∏ AD Login —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    const fioField = document.getElementById("fio_field");
    const lastField = document.getElementById("id_last_name");
    const firstField = document.getElementById("id_first_name");
    const middleField = document.getElementById("id_middle_name");
    const adLoginField = document.getElementById("ad_login_field");

    fioField.addEventListener("input", () => {
        const parts = fioField.value.trim().split(" ");
        lastField.value = parts[0] || "";
        firstField.value = parts[1] || "";
        middleField.value = parts[2] || "";
    });

    [lastField, firstField, middleField].forEach(field => {
        field.addEventListener("input", () => {
            let parts = [lastField.value, firstField.value, middleField.value].filter(p => p);
            fioField.value = parts.join(" ");
        });
    });

    window.updateADPrefix = function() {
        adLoginField.value = adLoginField.value.replace(/^CORP\\/, "");
        const displayVal = "CORP\\" + adLoginField.value;
        adLoginField.dataset.display = displayVal;
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('settings-modal');
    if (event.target === modal) {
        closeSettings();
    }
}
</script>

<style>
  input[type="text"], input[type="email"], input[type="date"], select, textarea {
    box-sizing: border-box;
  }

  #save-btn.bg-green-600 {
    background-color: #16a34a;
    font-weight: bold;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø–∞—Ä–æ–ª–µ–π */
  .password-field-wrapper {
      position: relative;
      margin-bottom: 8px;
  }

  .password-field {
      margin-bottom: 4px;
  }

  .password-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2px;
  }

  .password-generate {
      background: none;
      border: none;
      cursor: pointer;
      color: #6b7280;
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 4px;
  }

  .password-generate:hover {
      color: #3b82f6;
      background-color: #f3f4f6;
  }

  .password-strength {
      font-size: 11px;
      height: 14px;
      line-height: 14px;
  }

  .strength-weak { color: #ef4444; }
  .strength-medium { color: #f59e0b; }
  .strength-strong { color: #10b981; }

  .settings-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
  }

  .settings-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .settings-option {
      margin-bottom: 15px;
  }

  .settings-option label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
  }
</style>

{% endblock %}